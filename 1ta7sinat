//+------------------------------------------------------------------+
//|                   Enhanced Multi-Asset Manual Trading EA          |
//|                  EA Ù…Ø­Ø³Ù‘Ù† Ù„Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„           |
//+------------------------------------------------------------------+
#property copyright "Professional Trading Solutions v2.0"
#property version   "2.0"
#property strict
#property description "EA Ù…Ø­Ø³Ù‘Ù† Ù„Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ M1 Ùˆ M5 Ù…Ø¹ ØªØ­ÙƒÙ… ÙŠØ¯ÙˆÙŠ ÙƒØ§Ù…Ù„"
#property description "ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙˆØ±ÙƒØ³ ÙˆØ§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©"

#include <Trade\Trade.mqh>
#include <Trade\SymbolInfo.mqh>
#include <Trade\PositionInfo.mqh>
#include <Trade\AccountInfo.mqh>
#include <Trade\DealInfo.mqh>

//+------------------------------------------------------------------+
//| Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„                                                  |
//+------------------------------------------------------------------+
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
input group "â•â•â•â•â•â•â•â•â•â•â•â• Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© â•â•â•â•â•â•â•â•â•â•â•â•"
input double   InpLotSize = 0.01;               // Ø­Ø¬Ù… Ø§Ù„Ù„ÙˆØª Ù„ÙƒÙ„ ØµÙÙ‚Ø©
input bool     InpUseAutoLot = false;           // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù„ÙˆØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
input double   InpAutoLotRisk = 1.0;            // Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© % (Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
input int      InpMaxPositions = 3;             // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
input int      InpMaxPositionsPerSymbol = 1;    // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØµÙÙ‚Ø§Øª Ù„ÙƒÙ„ Ø±Ù…Ø²
input int      InpMaxDailyTrades = 10;          // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
input int      InpMagicNumber = 123456;         // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø­Ø±ÙŠ
input string   InpComment = "Manual EA v2";     // ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØµÙÙ‚Ø§Øª

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨ØªØ¯Ø§ÙˆÙ„Ù‡Ø§
input group "â•â•â•â•â•â•â•â•â•â•â•â• Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ù…ÙˆØ² â•â•â•â•â•â•â•â•â•â•â•â•"
input string   InpAllowedSymbols = "EURUSD,GBPUSD,XAUUSD,BTCUSD"; // Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨ØªØ¯Ø§ÙˆÙ„Ù‡Ø§
input bool     InpTradeCurrentChartOnly = false; // Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø±Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© ÙˆØ¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
input group "â•â•â•â•â•â•â•â•â•â•â•â• Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SL/TP â•â•â•â•â•â•â•â•â•â•â•â•"
input bool     InpUseStopLoss = true;          // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©
input int      InpStopLossPips = 20;           // ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·
input bool     InpUseTakeProfit = true;        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
input int      InpTakeProfitPips = 40;         // Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·
input bool     InpUseBreakeven = true;         // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„
input int      InpBreakevenPips = 15;          // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ø§Ø¯Ù„ Ø¹Ù†Ø¯ (Ù†Ù‚Ø§Ø·)
input int      InpBreakevenProfitPips = 2;     // Ø±Ø¨Ø­ Ø§Ù„ØªØ¹Ø§Ø¯Ù„ (Ù†Ù‚Ø§Ø·)
input bool     InpUseTrailingStop = true;      // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…ØªØ­Ø±Ùƒ
input int      InpTrailingStartPips = 15;      // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ­Ø±Ùƒ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·
input int      InpTrailingStepPips = 5;        // Ø®Ø·ÙˆØ© Ø§Ù„ØªØ­Ø±Ùƒ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ
input group "â•â•â•â•â•â•â•â•â•â•â•â• Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ â•â•â•â•â•â•â•â•â•â•â•â•"
input bool     InpTradeM1 = true;              // Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ M1
input bool     InpTradeM5 = true;              // Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ M5
input int      InpMinCandlesBetweenTrades = 3; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù…Ù† Ø§Ù„Ø´Ù…ÙˆØ¹ Ø¨ÙŠÙ† Ø§Ù„ØµÙÙ‚Ø§Øª

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
input group "â•â•â•â•â•â•â•â•â•â•â•â• Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© â•â•â•â•â•â•â•â•â•â•â•â•"
input int      InpFastMA = 20;                 // ÙØªØ±Ø© Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±ÙŠØ¹
input int      InpSlowMA = 50;                 // ÙØªØ±Ø© Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¨Ø·ÙŠØ¡
input ENUM_MA_METHOD InpMAMethod = MODE_EMA;   // Ù†ÙˆØ¹ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØªØ­Ø±Ùƒ
input int      InpRSIPeriod = 14;              // ÙØªØ±Ø© RSI
input double   InpRSIOverbought = 70;          // Ù…Ø³ØªÙˆÙ‰ Ø°Ø±ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¡
input double   InpRSIOversold = 30;            // Ù…Ø³ØªÙˆÙ‰ Ø°Ø±ÙˆØ© Ø§Ù„Ø¨ÙŠØ¹
input bool     InpUseVolumeFilter = true;      // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙ„ØªØ± Ø§Ù„Ø­Ø¬Ù…
input double   InpMinVolumeRatio = 1.5;        // Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ø¯Ù†Ù‰

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±
input group "â•â•â•â•â•â•â•â•â•â•â•â• Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± â•â•â•â•â•â•â•â•â•â•â•â•"
input bool     InpUseRiskManagement = true;    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±
input double   InpMaxRiskPercent = 2.0;        // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø®Ø§Ø·Ø±Ø© % Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
input double   InpMaxDailyLossPercent = 6.0;   // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© %
input double   InpMaxDrawdownPercent = 20.0;   // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø³Ø­Ø¨ %
input bool     InpCloseAllOnMaxLoss = true;    // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù‚ØµÙˆÙ‰

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Øª
input group "â•â•â•â•â•â•â•â•â•â•â•â• Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Øª â•â•â•â•â•â•â•â•â•â•â•â•"
input bool     InpUseTimeFilter = true;        // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙ„ØªØ± Ø§Ù„ÙˆÙ‚Øª
input int      InpStartHour = 1;               // Ø³Ø§Ø¹Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø§ÙˆÙ„
input int      InpEndHour = 23;                // Ø³Ø§Ø¹Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ¯Ø§ÙˆÙ„
input bool     InpCloseOnFriday = true;        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø§Øª ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©
input int      InpFridayCloseHour = 20;        // Ø³Ø§Ø¹Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©
input bool     InpAvoidNews = true;            // ØªØ¬Ù†Ø¨ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
input int      InpNewsAvoidMinutes = 30;       // Ø¯Ù‚Ø§Ø¦Ù‚ ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£ØµÙˆÙ„
input group "â•â•â•â•â•â•â•â•â•â•â•â• Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£ØµÙˆÙ„ â•â•â•â•â•â•â•â•â•â•â•â•"
// Ø§Ù„Ø°Ù‡Ø¨
input double   InpGoldMultiplier = 1.5;        // Ù…Ø¶Ø§Ø¹Ù Ø­Ø¬Ù… SL/TP Ù„Ù„Ø°Ù‡Ø¨
input double   InpGoldMaxLot = 0.1;            // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ÙˆØª Ù„Ù„Ø°Ù‡Ø¨
// Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
input double   InpCryptoMultiplier = 2.0;      // Ù…Ø¶Ø§Ø¹Ù Ø­Ø¬Ù… SL/TP Ù„Ù„ÙƒØ±ÙŠØ¨ØªÙˆ
input double   InpCryptoMaxLot = 0.05;         // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ÙˆØª Ù„Ù„ÙƒØ±ÙŠØ¨ØªÙˆ
input bool     InpCryptoReduceWeekend = true;  // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙÙŠ Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹

//+------------------------------------------------------------------+
//| Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª                                                   |
//+------------------------------------------------------------------+
// Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£ØµÙˆÙ„
enum ENUM_ASSET_TYPE {
    ASSET_FOREX,      // Ø¹Ù…Ù„Ø§Øª
    ASSET_GOLD,       // Ø°Ù‡Ø¨
    ASSET_SILVER,     // ÙØ¶Ø©
    ASSET_CRYPTO,     // Ø¹Ù…Ù„Ø§Øª Ø±Ù‚Ù…ÙŠØ©
    ASSET_INDEX,      // Ù…Ø¤Ø´Ø±Ø§Øª
    ASSET_OTHER       // Ø£Ø®Ø±Ù‰
};

// Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ØµÙ„ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
struct AssetInfo {
    string symbol;
    ENUM_ASSET_TYPE type;
    double pip_size;
    double pip_value;
    int digits;
    double min_lot;
    double max_lot;
    double lot_step;
    double sl_multiplier;
    double tp_multiplier;
    string description;
    bool is_active;
};

// Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
struct MarketState {
    double fast_ma_current;
    double fast_ma_previous;
    double slow_ma_current;
    double slow_ma_previous;
    double rsi_current;
    double rsi_previous;
    double volume_current;
    double volume_average;
    bool ma_cross_up;
    bool ma_cross_down;
    bool rsi_overbought;
    bool rsi_oversold;
    bool volume_confirmed;
    datetime last_signal_time;
    int bars_since_signal;
};

// Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„
struct TradingStats {
    int total_trades;
    int winning_trades;
    int losing_trades;
    double total_profit;
    double total_loss;
    double max_profit;
    double max_loss;
    double consecutive_wins;
    double consecutive_losses;
    datetime last_trade_time;
};

//+------------------------------------------------------------------+
//| Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©                                                     |
//+------------------------------------------------------------------+
CTrade trade;
CSymbolInfo symbol_info;
CPositionInfo position_info;
CAccountInfo account_info;
CDealInfo deal_info;

// Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ØµÙˆÙ„
AssetInfo assets[];
int active_assets_count = 0;

// Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚ Ù„ÙƒÙ„ Ø±Ù…Ø² ÙˆØ¥Ø·Ø§Ø± Ø²Ù…Ù†ÙŠ
MarketState market_states_m1[];
MarketState market_states_m5[];

// Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
TradingStats stats;
double initial_balance;
double daily_starting_balance;
double peak_balance;
int daily_trades_count;
datetime current_day;

// Ù…Ø¤Ø´Ø±Ø§Øª
struct IndicatorHandles {
    int fast_ma_m1;
    int slow_ma_m1;
    int rsi_m1;
    int fast_ma_m5;
    int slow_ma_m5;
    int rsi_m5;
};
IndicatorHandles indicators[];

//+------------------------------------------------------------------+
//| Expert initialization function                                    |
//+------------------------------------------------------------------+
int OnInit() {
    Print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Print("â•‘   Enhanced Multi-Asset Manual Trading EA v2.0    â•‘");
    Print("â•‘          EA Ù…Ø­Ø³Ù‘Ù† Ù„Ù„ØªØ¯Ø§ÙˆÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„           â•‘");
    Print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    // ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„
    trade.SetExpertMagicNumber(InpMagicNumber);
    trade.SetDeviationInPoints(10);
    trade.SetTypeFilling(ORDER_FILLING_IOC);
    trade.SetAsyncMode(false);
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨ØªØ¯Ø§ÙˆÙ„Ù‡Ø§
    if(!InitializeAssets()) {
        Print("âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ØµÙˆÙ„");
        return INIT_FAILED;
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ù„ÙƒÙ„ Ø£ØµÙ„
    if(!InitializeIndicators()) {
        Print("âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª");
        return INIT_FAILED;
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±
    InitializeRiskManagement();
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    InitializeStats();
    
    // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø¯Ø¡
    PrintStartupInfo();
    
    // ØªØ¹ÙŠÙŠÙ† Timer Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¯ÙˆØ±ÙŠØ©
    EventSetTimer(60); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
    
    return INIT_SUCCEEDED;
}

//+------------------------------------------------------------------+
//| ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨ØªØ¯Ø§ÙˆÙ„Ù‡Ø§                                    |
//+------------------------------------------------------------------+
bool InitializeAssets() {
    string symbols[];
    
    if(InpTradeCurrentChartOnly) {
        // Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
        ArrayResize(symbols, 1);
        symbols[0] = _Symbol;
    } else {
        // ØªØ­Ù„ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§
        string allowed_list = InpAllowedSymbols;
        StringReplace(allowed_list, " ", "");
        int count = StringSplit(allowed_list, ',', symbols);
        
        if(count == 0) {
            Print("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ù…ÙˆØ² Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„ØªØ¯Ø§ÙˆÙ„");
            return false;
        }
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒÙ„ Ø£ØµÙ„
    ArrayResize(assets, ArraySize(symbols));
    ArrayResize(market_states_m1, ArraySize(symbols));
    ArrayResize(market_states_m5, ArraySize(symbols));
    ArrayResize(indicators, ArraySize(symbols));
    
    active_assets_count = 0;
    
    for(int i = 0; i < ArraySize(symbols); i++) {
        string symbol = symbols[i];
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø±Ù…Ø²
        if(!SymbolSelect(symbol, true)) {
            Print("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø±Ù…Ø² ", symbol, " ØºÙŠØ± Ù…ØªÙˆÙØ±");
            continue;
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ØµÙ„
        if(InitializeAsset(i, symbol)) {
            active_assets_count++;
        }
    }
    
    if(active_assets_count == 0) {
        Print("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆÙ„ Ù†Ø´Ø·Ø© Ù„Ù„ØªØ¯Ø§ÙˆÙ„");
        return false;
    }
    
    Print("âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© ", active_assets_count, " Ø£ØµÙ„ Ù„Ù„ØªØ¯Ø§ÙˆÙ„");
    return true;
}

//+------------------------------------------------------------------+
//| ØªÙ‡ÙŠØ¦Ø© Ø£ØµÙ„ ÙˆØ§Ø­Ø¯                                                   |
//+------------------------------------------------------------------+
bool InitializeAsset(int index, string symbol) {
    assets[index].symbol = symbol;
    assets[index].is_active = false;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ù…Ø²
    CSymbolInfo temp_symbol;
    if(!temp_symbol.Name(symbol)) {
        Print("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ", symbol);
        return false;
    }
    
    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„
    assets[index].type = DetectAssetType(symbol, temp_symbol);
    assets[index].description = GetAssetDescription(assets[index].type);
    
    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
    assets[index].digits = (int)temp_symbol.Digits();
    assets[index].min_lot = temp_symbol.LotsMin();
    assets[index].max_lot = temp_symbol.LotsMax();
    assets[index].lot_step = temp_symbol.LotsStep();
    
    // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù†Ù‚Ø·Ø©
    CalculatePipSize(index, temp_symbol);
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„
    ApplyAssetMultipliers(index);
    
    // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ØµÙ„
    PrintAssetInfo(index);
    
    assets[index].is_active = true;
    return true;
}

//+------------------------------------------------------------------+
//| ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„                                                  |
//+------------------------------------------------------------------+
ENUM_ASSET_TYPE DetectAssetType(string symbol, CSymbolInfo &sym_info) {
    string symbol_upper = symbol;
    StringToUpper(symbol_upper);
    string base_currency = sym_info.CurrencyBase();
    string profit_currency = sym_info.CurrencyProfit();
    
    // ÙØ­Øµ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
    string crypto_symbols[] = {"BTC", "ETH", "LTC", "XRP", "BNB", "ADA", "DOGE", 
                              "DOT", "LINK", "UNI", "MATIC", "SOL", "AVAX"};
    for(int i = 0; i < ArraySize(crypto_symbols); i++) {
        if(StringFind(symbol_upper, crypto_symbols[i]) >= 0) {
            return ASSET_CRYPTO;
        }
    }
    
    // ÙØ­Øµ Ø§Ù„Ø°Ù‡Ø¨
    if(StringFind(symbol_upper, "XAU") >= 0 || 
       StringFind(symbol_upper, "GOLD") >= 0) {
        return ASSET_GOLD;
    }
    
    // ÙØ­Øµ Ø§Ù„ÙØ¶Ø©
    if(StringFind(symbol_upper, "XAG") >= 0 || 
       StringFind(symbol_upper, "SILVER") >= 0) {
        return ASSET_SILVER;
    }
    
    // ÙØ­Øµ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
    string index_symbols[] = {"US30", "US500", "NAS100", "DAX", "FTSE", "JP225"};
    for(int i = 0; i < ArraySize(index_symbols); i++) {
        if(StringFind(symbol_upper, index_symbols[i]) >= 0) {
            return ASSET_INDEX;
        }
    }
    
    // ÙØ­Øµ Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
    string forex_currencies[] = {"USD", "EUR", "GBP", "JPY", "CHF", "CAD", "AUD", "NZD"};
    bool base_is_forex = false;
    bool profit_is_forex = false;
    
    for(int i = 0; i < ArraySize(forex_currencies); i++) {
        if(base_currency == forex_currencies[i]) base_is_forex = true;
        if(profit_currency == forex_currencies[i]) profit_is_forex = true;
    }
    
    if(base_is_forex && profit_is_forex) {
        return ASSET_FOREX;
    }
    
    return ASSET_OTHER;
}

//+------------------------------------------------------------------+
//| Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù†Ù‚Ø·Ø©                                                  |
//+------------------------------------------------------------------+
void CalculatePipSize(int index, CSymbolInfo &sym_info) {
    ENUM_ASSET_TYPE type = assets[index].type;
    int digits = assets[index].digits;
    
    switch(type) {
        case ASSET_CRYPTO:
            // Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
            if(StringFind(assets[index].symbol, "BTC") >= 0) {
                assets[index].pip_size = 1.0; // 1 Ø¯ÙˆÙ„Ø§Ø± Ù„Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†
            } else {
                assets[index].pip_size = sym_info.TickSize() * 10;
            }
            break;
            
        case ASSET_GOLD:
            // Ø§Ù„Ø°Ù‡Ø¨
            assets[index].pip_size = (digits == 2) ? 0.1 : 0.01;
            break;
            
        case ASSET_SILVER:
            // Ø§Ù„ÙØ¶Ø©
            assets[index].pip_size = (digits == 3) ? 0.01 : 0.001;
            break;
            
        case ASSET_INDEX:
            // Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
            assets[index].pip_size = 1.0;
            break;
            
        case ASSET_FOREX:
            // Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
            if(StringFind(sym_info.CurrencyProfit(), "JPY") >= 0) {
                assets[index].pip_size = (digits == 3) ? 0.01 : 0.001;
            } else {
                assets[index].pip_size = (digits == 5) ? 0.0001 : 0.00001;
            }
            break;
            
        default:
            assets[index].pip_size = sym_info.Point() * 10;
    }
}

//+------------------------------------------------------------------+
//| ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„                                   |
//+------------------------------------------------------------------+
void ApplyAssetMultipliers(int index) {
    assets[index].sl_multiplier = 1.0;
    assets[index].tp_multiplier = 1.0;
    
    switch(assets[index].type) {
        case ASSET_GOLD:
            assets[index].sl_multiplier = InpGoldMultiplier;
            assets[index].tp_multiplier = InpGoldMultiplier;
            assets[index].max_lot = MathMin(assets[index].max_lot, InpGoldMaxLot);
            break;
            
        case ASSET_CRYPTO:
            assets[index].sl_multiplier = InpCryptoMultiplier;
            assets[index].tp_multiplier = InpCryptoMultiplier;
            assets[index].max_lot = MathMin(assets[index].max_lot, InpCryptoMaxLot);
            break;
            
        case ASSET_INDEX:
            assets[index].sl_multiplier = 1.5;
            assets[index].tp_multiplier = 1.5;
            break;
    }
}

//+------------------------------------------------------------------+
//| Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØµÙ Ù†ÙˆØ¹ Ø§Ù„Ø£ØµÙ„                                        |
//+------------------------------------------------------------------+
string GetAssetDescription(ENUM_ASSET_TYPE type) {
    switch(type) {
        case ASSET_FOREX:  return "Ø²ÙˆØ¬ Ø¹Ù…Ù„Ø§Øª";
        case ASSET_GOLD:   return "Ø°Ù‡Ø¨";
        case ASSET_SILVER: return "ÙØ¶Ø©";
        case ASSET_CRYPTO: return "Ø¹Ù…Ù„Ø© Ø±Ù‚Ù…ÙŠØ©";
        case ASSET_INDEX:  return "Ù…Ø¤Ø´Ø±";
        default:           return "Ø£ØµÙ„ Ø¢Ø®Ø±";
    }
}

//+------------------------------------------------------------------+
//| Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ØµÙ„                                             |
//+------------------------------------------------------------------+
void PrintAssetInfo(int index) {
    Print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Print("Ø§Ù„Ø£ØµÙ„ #", index + 1, ": ", assets[index].symbol);
    Print("Ø§Ù„Ù†ÙˆØ¹: ", assets[index].description);
    Print("Ø­Ø¬Ù… Ø§Ù„Ù†Ù‚Ø·Ø©: ", DoubleToString(assets[index].pip_size, assets[index].digits));
    Print("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ÙˆØª: ", assets[index].min_lot);
    Print("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ÙˆØª: ", assets[index].max_lot);
    Print("Ù…Ø¶Ø§Ø¹Ù SL: ", assets[index].sl_multiplier);
    Print("Ù…Ø¶Ø§Ø¹Ù TP: ", assets[index].tp_multiplier);
}

//+------------------------------------------------------------------+
//| ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª                                                   |
//+------------------------------------------------------------------+
bool InitializeIndicators() {
    for(int i = 0; i < ArraySize(assets); i++) {
        if(!assets[i].is_active) continue;
        
        string symbol = assets[i].symbol;
        
        // Ù…Ø¤Ø´Ø±Ø§Øª M1
        if(InpTradeM1) {
            indicators[i].fast_ma_m1 = iMA(symbol, PERIOD_M1, InpFastMA, 0, InpMAMethod, PRICE_CLOSE);
            indicators[i].slow_ma_m1 = iMA(symbol, PERIOD_M1, InpSlowMA, 0, InpMAMethod, PRICE_CLOSE);
            indicators[i].rsi_m1 = iRSI(symbol, PERIOD_M1, InpRSIPeriod, PRICE_CLOSE);
            
            if(indicators[i].fast_ma_m1 == INVALID_HANDLE || 
               indicators[i].slow_ma_m1 == INVALID_HANDLE ||
               indicators[i].rsi_m1 == INVALID_HANDLE) {
                Print("âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù…Ø¤Ø´Ø±Ø§Øª M1 Ù„Ù„Ø±Ù…Ø² ", symbol);
                return false;
            }
        }
        
        // Ù…Ø¤Ø´Ø±Ø§Øª M5
        if(InpTradeM5) {
            indicators[i].fast_ma_m5 = iMA(symbol, PERIOD_M5, InpFastMA, 0, InpMAMethod, PRICE_CLOSE);
            indicators[i].slow_ma_m5 = iMA(symbol, PERIOD_M5, InpSlowMA, 0, InpMAMethod, PRICE_CLOSE);
            indicators[i].rsi_m5 = iRSI(symbol, PERIOD_M5, InpRSIPeriod, PRICE_CLOSE);
            
            if(indicators[i].fast_ma_m5 == INVALID_HANDLE || 
               indicators[i].slow_ma_m5 == INVALID_HANDLE ||
               indicators[i].rsi_m5 == INVALID_HANDLE) {
                Print("âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù…Ø¤Ø´Ø±Ø§Øª M5 Ù„Ù„Ø±Ù…Ø² ", symbol);
                return false;
            }
        }
    }
    
    return true;
}

//+------------------------------------------------------------------+
//| ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±                                              |
//+------------------------------------------------------------------+
void InitializeRiskManagement() {
    initial_balance = account_info.Balance();
    daily_starting_balance = initial_balance;
    peak_balance = initial_balance;
    daily_trades_count = 0;
    current_day = TimeCurrent() - (TimeCurrent() % 86400);
}

//+------------------------------------------------------------------+
//| ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª                                                |
//+------------------------------------------------------------------+
void InitializeStats() {
    stats.total_trades = 0;
    stats.winning_trades = 0;
    stats.losing_trades = 0;
    stats.total_profit = 0;
    stats.total_loss = 0;
    stats.max_profit = 0;
    stats.max_loss = 0;
    stats.consecutive_wins = 0;
    stats.consecutive_losses = 0;
    stats.last_trade_time = 0;
}

//+------------------------------------------------------------------+
//| Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø¯Ø¡                                              |
//+------------------------------------------------------------------+
void PrintStartupInfo() {
    Print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Print("â•‘              Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª EA                           â•‘");
    Print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    Print("â•‘ Ø­Ø¬Ù… Ø§Ù„Ù„ÙˆØª: ", InpUseAutoLot ? "ØªÙ„Ù‚Ø§Ø¦ÙŠ" : DoubleToString(InpLotSize, 2));
    if(InpUseAutoLot) {
        Print("â•‘ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©: ", InpAutoLotRisk, "%");
    }
    Print("â•‘ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØµÙÙ‚Ø§Øª: ", InpMaxPositions);
    Print("â•‘ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„ÙƒÙ„ Ø±Ù…Ø²: ", InpMaxPositionsPerSymbol);
    Print("â•‘ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ: ", InpMaxDailyTrades);
    Print("â•‘ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: ", InpStopLossPips, " Ù†Ù‚Ø·Ø©");
    Print("â•‘ Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: ", InpTakeProfitPips, " Ù†Ù‚Ø·Ø©");
    Print("â•‘ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„: ", InpUseBreakeven ? "Ù…ÙØ¹Ù„" : "Ù…Ø¹Ø·Ù„");
    Print("â•‘ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…ØªØ­Ø±Ùƒ: ", InpUseTrailingStop ? "Ù…ÙØ¹Ù„" : "Ù…Ø¹Ø·Ù„");
    Print("â•‘ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ M1: ", InpTradeM1 ? "Ù…ÙØ¹Ù„" : "Ù…Ø¹Ø·Ù„");
    Print("â•‘ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ M5: ", InpTradeM5 ? "Ù…ÙØ¹Ù„" : "Ù…Ø¹Ø·Ù„");
    Print("â•‘ ÙÙ„ØªØ± Ø§Ù„ÙˆÙ‚Øª: ", InpUseTimeFilter ? 
          StringFormat("%d:00 - %d:00", InpStartHour, InpEndHour) : "Ù…Ø¹Ø·Ù„");
    Print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

//+------------------------------------------------------------------+
//| Expert deinitialization function                                  |
//+------------------------------------------------------------------+
void OnDeinit(const int reason) {
    EventKillTimer();
    
    // ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
    ReleaseIndicators();
    
    // Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡
    PrintPerformanceSummary();
    
    Print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Print("â•‘          Ø¥ÙŠÙ‚Ø§Ù EA - Ø§Ù„Ø³Ø¨Ø¨: ", GetDeInitReasonText(reason));
    Print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
}

//+------------------------------------------------------------------+
//| ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª                                                   |
//+------------------------------------------------------------------+
void ReleaseIndicators() {
    for(int i = 0; i < ArraySize(indicators); i++) {
        if(indicators[i].fast_ma_m1 != INVALID_HANDLE) IndicatorRelease(indicators[i].fast_ma_m1);
        if(indicators[i].slow_ma_m1 != INVALID_HANDLE) IndicatorRelease(indicators[i].slow_ma_m1);
        if(indicators[i].rsi_m1 != INVALID_HANDLE) IndicatorRelease(indicators[i].rsi_m1);
        
        if(indicators[i].fast_ma_m5 != INVALID_HANDLE) IndicatorRelease(indicators[i].fast_ma_m5);
        if(indicators[i].slow_ma_m5 != INVALID_HANDLE) IndicatorRelease(indicators[i].slow_ma_m5);
        if(indicators[i].rsi_m5 != INVALID_HANDLE) IndicatorRelease(indicators[i].rsi_m5);
    }
}

//+------------------------------------------------------------------+
//| Expert tick function                                              |
//+------------------------------------------------------------------+
void OnTick() {
    // ÙØ­Øµ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±
    if(InpUseRiskManagement && !CheckRiskLimits()) {
        if(InpCloseAllOnMaxLoss) {
            CloseAllPositions("ØªØ¬Ø§ÙˆØ² Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø®Ø§Ø·Ø±");
        }
        return;
    }
    
    // ÙØ­Øµ Ø§Ù„ÙˆÙ‚Øª
    if(InpUseTimeFilter && !IsTimeToTrade()) {
        return;
    }
    
    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
    ManageOpenPositions();
    
    // ÙØ­Øµ Ø¥Ø´Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙƒÙ„ Ø£ØµÙ„ Ù†Ø´Ø·
    for(int i = 0; i < ArraySize(assets); i++) {
        if(!assets[i].is_active) continue;
        
        // ÙØ­Øµ M1
        if(InpTradeM1 && IsNewBar(assets[i].symbol, PERIOD_M1)) {
            CheckForSignals(i, PERIOD_M1);
        }
        
        // ÙØ­Øµ M5
        if(InpTradeM5 && IsNewBar(assets[i].symbol, PERIOD_M5)) {
            CheckForSignals(i, PERIOD_M5);
        }
    }
}

//+------------------------------------------------------------------+
//| ÙØ­Øµ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø®Ø§Ø·Ø±                                                |
//+------------------------------------------------------------------+
bool CheckRiskLimits() {
    if(!InpUseRiskManagement) return true;
    
    double current_balance = account_info.Balance();
    double current_equity = account_info.Equity();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø±ÙˆØ©
    if(current_balance > peak_balance) {
        peak_balance = current_balance;
    }
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø­Ø¨
    double drawdown = ((peak_balance - current_equity) / peak_balance) * 100;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    double daily_loss = ((daily_starting_balance - current_balance) / daily_starting_balance) * 100;
    
    // ÙØ­Øµ Ø§Ù„Ø­Ø¯ÙˆØ¯
    if(drawdown > InpMaxDrawdownPercent) {
        Print("âš ï¸ ØªØ­Ø°ÙŠØ±: ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø£Ù‚ØµÙ‰: ", DoubleToString(drawdown, 2), "%");
        return false;
    }
    
    if(daily_loss > InpMaxDailyLossPercent) {
        Print("âš ï¸ ØªØ­Ø°ÙŠØ±: ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: ", DoubleToString(daily_loss, 2), "%");
        return false;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    datetime new_day = TimeCurrent() - (TimeCurrent() % 86400);
    if(new_day != current_day) {
        current_day = new_day;
        daily_starting_balance = current_balance;
        daily_trades_count = 0;
    }
    
    return true;
}

//+------------------------------------------------------------------+
//| ÙØ­Øµ ÙˆÙ‚Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„                                                 |
//+------------------------------------------------------------------+
bool IsTimeToTrade() {
    MqlDateTime time;
    TimeToStruct(TimeCurrent(), time);
    
    // ÙØ­Øµ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„
    if(time.hour < InpStartHour || time.hour >= InpEndHour) {
        return false;
    }
    
    // ÙØ­Øµ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©
    if(InpCloseOnFriday && time.day_of_week == 5 && time.hour >= InpFridayCloseHour) {
        return false;
    }
    
    // ÙØ­Øµ Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„ÙƒØ±ÙŠØ¨ØªÙˆ
    if(InpCryptoReduceWeekend && (time.day_of_week == 0 || time.day_of_week == 6)) {
        // Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¨Ø­Ø°Ø± ÙÙŠ Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„ÙƒØ±ÙŠØ¨ØªÙˆ
        return (time.hour >= 10 && time.hour <= 20);
    }
    
    return true;
}

//+------------------------------------------------------------------+
//| Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©                                          |
//+------------------------------------------------------------------+
void ManageOpenPositions() {
    for(int i = PositionsTotal() - 1; i >= 0; i--) {
        if(position_info.SelectByIndex(i)) {
            if(position_info.Magic() != InpMagicNumber) continue;
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ØµÙ„
            int asset_index = GetAssetIndex(position_info.Symbol());
            if(asset_index < 0) continue;
            
            // Ø¥Ø¯Ø§Ø±Ø© Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„
            if(InpUseBreakeven) {
                UpdateBreakeven(asset_index);
            }
            
            // Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…ØªØ­Ø±Ùƒ
            if(InpUseTrailingStop) {
                UpdateTrailingStop(asset_index);
            }
        }
    }
}

//+------------------------------------------------------------------+
//| ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„                                              |
//+------------------------------------------------------------------+
void UpdateBreakeven(int asset_index) {
    double current_price = position_info.PriceCurrent();
    double open_price = position_info.PriceOpen();
    double current_sl = position_info.StopLoss();
    
    double breakeven_distance = InpBreakevenPips * assets[asset_index].pip_size;
    double breakeven_profit = InpBreakevenProfitPips * assets[asset_index].pip_size;
    
    if(position_info.PositionType() == POSITION_TYPE_BUY) {
        if(current_price - open_price >= breakeven_distance) {
            double new_sl = open_price + breakeven_profit;
            
            if(current_sl < new_sl) {
                trade.PositionModify(position_info.Ticket(), 
                                    NormalizeDouble(new_sl, assets[asset_index].digits), 
                                    position_info.TakeProfit());
            }
        }
    }
    else if(position_info.PositionType() == POSITION_TYPE_SELL) {
        if(open_price - current_price >= breakeven_distance) {
            double new_sl = open_price - breakeven_profit;
            
            if(current_sl > new_sl || current_sl == 0) {
                trade.PositionModify(position_info.Ticket(), 
                                    NormalizeDouble(new_sl, assets[asset_index].digits), 
                                    position_info.TakeProfit());
            }
        }
    }
}

//+------------------------------------------------------------------+
//| ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…ØªØ­Ø±Ùƒ                                       |
//+------------------------------------------------------------------+
void UpdateTrailingStop(int asset_index) {
    double current_price = position_info.PriceCurrent();
    double current_sl = position_info.StopLoss();
    double open_price = position_info.PriceOpen();
    
    double trailing_distance = InpTrailingStartPips * assets[asset_index].pip_size;
    double trailing_step = InpTrailingStepPips * assets[asset_index].pip_size;
    
    if(position_info.PositionType() == POSITION_TYPE_BUY) {
        if(current_price - open_price >= trailing_distance) {
            double new_sl = current_price - trailing_distance;
            
            if(new_sl > current_sl + trailing_step) {
                trade.PositionModify(position_info.Ticket(), 
                                    NormalizeDouble(new_sl, assets[asset_index].digits), 
                                    position_info.TakeProfit());
            }
        }
    }
    else if(position_info.PositionType() == POSITION_TYPE_SELL) {
        if(open_price - current_price >= trailing_distance) {
            double new_sl = current_price + trailing_distance;
            
            if(new_sl < current_sl - trailing_step || current_sl == 0) {
                trade.PositionModify(position_info.Ticket(), 
                                    NormalizeDouble(new_sl, assets[asset_index].digits), 
                                    position_info.TakeProfit());
            }
        }
    }
}

//+------------------------------------------------------------------+
//| ÙØ­Øµ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª                                                     |
//+------------------------------------------------------------------+
void CheckForSignals(int asset_index, ENUM_TIMEFRAMES timeframe) {
    // ÙØ­Øµ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª
    if(!CanOpenNewPosition(asset_index)) return;
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚
    MarketState *state;
    if(timeframe == PERIOD_M1) {
        state = &market_states_m1[asset_index];
    } else {
        state = &market_states_m5[asset_index];
    }
    
    UpdateMarketState(asset_index, timeframe, state);
    
    // ÙØ­Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù…Ù† Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù†Ø° Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©
    if(state.bars_since_signal < InpMinCandlesBetweenTrades) {
        return;
    }
    
    // ÙØ­Øµ ÙÙ„ØªØ± Ø§Ù„Ø­Ø¬Ù…
    if(InpUseVolumeFilter && !state.volume_confirmed) {
        return;
    }
    
    // ÙØ­Øµ Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
    if(state.ma_cross_up && !state.rsi_overbought) {
        if(OpenPosition(asset_index, ORDER_TYPE_BUY, timeframe)) {
            state.last_signal_time = TimeCurrent();
            state.bars_since_signal = 0;
        }
    }
    // ÙØ­Øµ Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ¹
    else if(state.ma_cross_down && !state.rsi_oversold) {
        if(OpenPosition(asset_index, ORDER_TYPE_SELL, timeframe)) {
            state.last_signal_time = TimeCurrent();
            state.bars_since_signal = 0;
        }
    }
}

//+------------------------------------------------------------------+
//| ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙˆÙ‚                                                |
//+------------------------------------------------------------------+
void UpdateMarketState(int asset_index, ENUM_TIMEFRAMES timeframe, MarketState *state) {
    double fast_ma[], slow_ma[], rsi[], volume[];
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    int handle_fast, handle_slow, handle_rsi;
    
    if(timeframe == PERIOD_M1) {
        handle_fast = indicators[asset_index].fast_ma_m1;
        handle_slow = indicators[asset_index].slow_ma_m1;
        handle_rsi = indicators[asset_index].rsi_m1;
    } else {
        handle_fast = indicators[asset_index].fast_ma_m5;
        handle_slow = indicators[asset_index].slow_ma_m5;
        handle_rsi = indicators[asset_index].rsi_m5;
    }
    
    // Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if(CopyBuffer(handle_fast, 0, 0, 3, fast_ma) != 3) return;
    if(CopyBuffer(handle_slow, 0, 0, 3, slow_ma) != 3) return;
    if(CopyBuffer(handle_rsi, 0, 0, 3, rsi) != 3) return;
    if(CopyTickVolume(assets[asset_index].symbol, timeframe, 0, 20, volume) < 20) return;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…
    state.fast_ma_previous = fast_ma[1];
    state.fast_ma_current = fast_ma[2];
    state.slow_ma_previous = slow_ma[1];
    state.slow_ma_current = slow_ma[2];
    state.rsi_previous = rsi[1];
    state.rsi_current = rsi[2];
    
    // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ù…
    double volume_sum = 0;
    for(int i = 1; i < 20; i++) {
        volume_sum += volume[i];
    }
    state.volume_average = volume_sum / 19;
    state.volume_current = volume[0];
    
    // ÙƒØ´Ù Ø§Ù„ØªÙ‚Ø§Ø·Ø¹Ø§Øª
    state.ma_cross_up = (state.fast_ma_previous <= state.slow_ma_previous && 
                        state.fast_ma_current > state.slow_ma_current);
    state.ma_cross_down = (state.fast_ma_previous >= state.slow_ma_previous && 
                          state.fast_ma_current < state.slow_ma_current);
    
    // ÙƒØ´Ù Ù…Ø³ØªÙˆÙŠØ§Øª RSI
    state.rsi_overbought = state.rsi_current > InpRSIOverbought;
    state.rsi_oversold = state.rsi_current < InpRSIOversold;
    
    // ÙØ­Øµ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ù…
    state.volume_confirmed = (state.volume_current > state.volume_average * InpMinVolumeRatio);
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ù…ÙˆØ¹
    state.bars_since_signal++;
}

//+------------------------------------------------------------------+
//| ÙØ­Øµ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ÙØªØ­ ØµÙÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©                                      |
//+------------------------------------------------------------------+
bool CanOpenNewPosition(int asset_index) {
    // ÙØ­Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    if(daily_trades_count >= InpMaxDailyTrades) {
        return false;
    }
    
    // Ø¹Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
    int total_positions = 0;
    int symbol_positions = 0;
    
    for(int i = 0; i < PositionsTotal(); i++) {
        if(position_info.SelectByIndex(i)) {
            if(position_info.Magic() == InpMagicNumber) {
                total_positions++;
                
                if(position_info.Symbol() == assets[asset_index].symbol) {
                    symbol_positions++;
                }
            }
        }
    }
    
    // ÙØ­Øµ Ø§Ù„Ø­Ø¯ÙˆØ¯
    if(total_positions >= InpMaxPositions) {
        return false;
    }
    
    if(symbol_positions >= InpMaxPositionsPerSymbol) {
        return false;
    }
    
    return true;
}

//+------------------------------------------------------------------+
//| ÙØªØ­ ØµÙÙ‚Ø©                                                         |
//+------------------------------------------------------------------+
bool OpenPosition(int asset_index, ENUM_ORDER_TYPE order_type, ENUM_TIMEFRAMES timeframe) {
    string symbol = assets[asset_index].symbol;
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ù…Ø²
    if(!symbol_info.Name(symbol)) return false;
    symbol_info.RefreshRates();
    
    double price, sl = 0, tp = 0;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ùˆ SL/TP
    if(order_type == ORDER_TYPE_BUY) {
        price = symbol_info.Ask();
        
        if(InpUseStopLoss) {
            double sl_distance = InpStopLossPips * assets[asset_index].pip_size * 
                               assets[asset_index].sl_multiplier;
            sl = price - sl_distance;
        }
        
        if(InpUseTakeProfit) {
            double tp_distance = InpTakeProfitPips * assets[asset_index].pip_size * 
                               assets[asset_index].tp_multiplier;
            tp = price + tp_distance;
        }
    }
    else {
        price = symbol_info.Bid();
        
        if(InpUseStopLoss) {
            double sl_distance = InpStopLossPips * assets[asset_index].pip_size * 
                               assets[asset_index].sl_multiplier;
            sl = price + sl_distance;
        }
        
        if(InpUseTakeProfit) {
            double tp_distance = InpTakeProfitPips * assets[asset_index].pip_size * 
                               assets[asset_index].tp_multiplier;
            tp = price - tp_distance;
        }
    }
    
    // ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    sl = NormalizeDouble(sl, assets[asset_index].digits);
    tp = NormalizeDouble(tp, assets[asset_index].digits);
    
    // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù„ÙˆØª
    double lot_size = CalculateLotSize(asset_index);
    if(lot_size <= 0) return false;
    
    // ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    string comment = StringFormat("%s | %s | %s | %s", 
                                 InpComment,
                                 assets[asset_index].description,
                                 TimeframeToString(timeframe),
                                 TimeToString(TimeCurrent(), TIME_MINUTES));
    
    // ÙØªØ­ Ø§Ù„ØµÙÙ‚Ø©
    if(trade.PositionOpen(symbol, order_type, lot_size, price, sl, tp, comment)) {
        daily_trades_count++;
        stats.total_trades++;
        
        Print("âœ… ØªÙ… ÙØªØ­ ØµÙÙ‚Ø©: ",
              (order_type == ORDER_TYPE_BUY ? "Ø´Ø±Ø§Ø¡ ğŸ“ˆ" : "Ø¨ÙŠØ¹ ğŸ“‰"),
              " | ", symbol,
              " | ", assets[asset_index].description,
              " | Ø§Ù„Ø­Ø¬Ù…: ", DoubleToString(lot_size, 2),
              " | Ø§Ù„Ø³Ø¹Ø±: ", DoubleToString(price, assets[asset_index].digits),
              " | SL: ", DoubleToString(sl, assets[asset_index].digits),
              " | TP: ", DoubleToString(tp, assets[asset_index].digits));
        
        return true;
    }
    else {
        Print("âŒ ÙØ´Ù„ ÙØªØ­ Ø§Ù„ØµÙÙ‚Ø©: ", trade.ResultComment(),
              " | Ø§Ù„ÙƒÙˆØ¯: ", trade.ResultRetcode());
        return false;
    }
}

//+------------------------------------------------------------------+
//| Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù„ÙˆØª                                                   |
//+------------------------------------------------------------------+
double CalculateLotSize(int asset_index) {
    double lot_size;
    
    if(InpUseAutoLot && InpUseStopLoss) {
        // Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©
        double risk_amount = account_info.Balance() * (InpAutoLotRisk / 100);
        double sl_pips = InpStopLossPips * assets[asset_index].sl_multiplier;
        
        // Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø·Ø© Ù„Ù€ 1 Ù„ÙˆØª
        double tick_value = symbol_info.TickValue();
        double tick_size = symbol_info.TickSize();
        double pip_value = (assets[asset_index].pip_size / tick_size) * tick_value;
        
        // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù„ÙˆØª
        lot_size = risk_amount / (sl_pips * pip_value);
    }
    else {
        // Ø­Ø¬Ù… Ø«Ø§Ø¨Øª
        lot_size = InpLotSize;
    }
    
    // ØªØ·Ø¨ÙŠØ¹ Ø­Ø³Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø±Ù…Ø²
    lot_size = MathMax(assets[asset_index].min_lot, lot_size);
    lot_size = MathMin(assets[asset_index].max_lot, lot_size);
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø®Ø·ÙˆØ© Ø§Ù„Ù„ÙˆØª
    lot_size = MathRound(lot_size / assets[asset_index].lot_step) * assets[asset_index].lot_step;
    
    return NormalizeDouble(lot_size, 2);
}

//+------------------------------------------------------------------+
//| Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙÙ‡Ø±Ø³ Ø§Ù„Ø£ØµÙ„                                          |
//+------------------------------------------------------------------+
int GetAssetIndex(string symbol) {
    for(int i = 0; i < ArraySize(assets); i++) {
        if(assets[i].symbol == symbol) {
            return i;
        }
    }
    return -1;
}

//+------------------------------------------------------------------+
//| ÙØ­Øµ Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©                                              |
//+------------------------------------------------------------------+
bool IsNewBar(string symbol, ENUM_TIMEFRAMES timeframe) {
    static datetime last_time[][2]; // [symbol_index][timeframe_index]
    static bool first_run = true;
    
    if(first_run) {
        ArrayResize(last_time, ArraySize(assets));
        first_run = false;
    }
    
    int asset_index = GetAssetIndex(symbol);
    if(asset_index < 0) return false;
    
    int tf_index = (timeframe == PERIOD_M1) ? 0 : 1;
    
    datetime current_time = iTime(symbol, timeframe, 0);
    
    if(current_time != last_time[asset_index][tf_index]) {
        last_time[asset_index][tf_index] = current_time;
        return true;
    }
    
    return false;
}

//+------------------------------------------------------------------+
//| ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¥Ù„Ù‰ Ù†Øµ                                     |
//+------------------------------------------------------------------+
string TimeframeToString(ENUM_TIMEFRAMES timeframe) {
    switch(timeframe) {
        case PERIOD_M1:  return "M1";
        case PERIOD_M5:  return "M5";
        case PERIOD_M15: return "M15";
        case PERIOD_M30: return "M30";
        case PERIOD_H1:  return "H1";
        case PERIOD_H4:  return "H4";
        case PERIOD_D1:  return "D1";
        case PERIOD_W1:  return "W1";
        case PERIOD_MN1: return "MN1";
        default:         return "Unknown";
    }
}

//+------------------------------------------------------------------+
//| Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª                                              |
//+------------------------------------------------------------------+
void CloseAllPositions(string reason = "") {
    Print("âš ï¸ Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª", reason != "" ? ": " + reason : "");
    
    for(int i = PositionsTotal() - 1; i >= 0; i--) {
        if(position_info.SelectByIndex(i)) {
            if(position_info.Magic() == InpMagicNumber) {
                trade.PositionClose(position_info.Ticket());
            }
        }
    }
}

//+------------------------------------------------------------------+
//| Ù…Ø¹Ø§Ù„Ø¬ Timer                                                      |
//+------------------------------------------------------------------+
void OnTimer() {
    // Ø·Ø¨Ø§Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¯ÙˆØ±ÙŠØ©
    static int timer_counter = 0;
    timer_counter++;
    
    if(timer_counter % 5 == 0) { // ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
        PrintCurrentStatus();
    }
    
    if(timer_counter % 60 == 0) { // ÙƒÙ„ Ø³Ø§Ø¹Ø©
        PrintDetailedReport();
        timer_counter = 0;
    }
}

//+------------------------------------------------------------------+
//| Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©                                            |
//+------------------------------------------------------------------+
void PrintCurrentStatus() {
    Print("\nâ•”â•â•â•â•â•â•â•â•â•â•â• Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© â•â•â•â•â•â•â•â•â•â•â•â•—");
    Print("â•‘ Ø§Ù„ÙˆÙ‚Øª: ", TimeToString(TimeCurrent(), TIME_DATE | TIME_MINUTES));
    Print("â•‘ Ø§Ù„Ø±ØµÙŠØ¯: ", DoubleToString(account_info.Balance(), 2));
    Print("â•‘ Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„: ", DoubleToString(account_info.Equity(), 2));
    Print("â•‘ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©: ", DoubleToString(account_info.Profit(), 2));
    Print("â•‘ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ", DoubleToString(account_info.Margin(), 2));
    Print("â•‘ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‡Ø§Ù…Ø´: ", DoubleToString(account_info.MarginLevel(), 2), "%");
    
    // Ø¹Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª
    int positions_count = 0;
    for(int i = 0; i < PositionsTotal(); i++) {
        if(position_info.SelectByIndex(i)) {
            if(position_info.Magic() == InpMagicNumber) {
                positions_count++;
            }
        }
    }
    
    Print("â•‘ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©: ", positions_count, "/", InpMaxPositions);
    Print("â•‘ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: ", daily_trades_count, "/", InpMaxDailyTrades);
    Print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
}

//+------------------------------------------------------------------+
//| Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„                                                |
//+------------------------------------------------------------------+
void PrintDetailedReport() {
    Print("\nâ•”â•â•â•â•â•â•â•â•â•â• ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ â•â•â•â•â•â•â•â•â•â•â•—");
    Print("â•‘ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙ‚Ø§Øª: ", stats.total_trades);
    
    if(stats.total_trades > 0) {
        double win_rate = (stats.winning_trades > 0) ? 
                         (double)stats.winning_trades / stats.total_trades * 100 : 0;
        
        Print("â•‘ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø­Ø©: ", stats.winning_trades, " (", 
              DoubleToString(win_rate, 1), "%)");
        Print("â•‘ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø®Ø§Ø³Ø±Ø©: ", stats.losing_trades);
        Print("â•‘ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­: ", DoubleToString(stats.total_profit, 2));
        Print("â•‘ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø³Ø§Ø±Ø©: ", DoubleToString(stats.total_loss, 2));
        Print("â•‘ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ", DoubleToString(stats.total_profit + stats.total_loss, 2));
        
        double profit_factor = (stats.total_loss != 0) ? 
                              MathAbs(stats.total_profit / stats.total_loss) : 0;
        Print("â•‘ Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø¨Ø­: ", DoubleToString(profit_factor, 2));
    }
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø­Ø¨
    double current_balance = account_info.Balance();
    double drawdown = ((peak_balance - current_balance) / peak_balance) * 100;
    
    Print("â•‘ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ: ", DoubleToString(drawdown, 2), "%");
    Print("â•‘ Ø£Ù‚ØµÙ‰ Ø±ØµÙŠØ¯: ", DoubleToString(peak_balance, 2));
    Print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
}

//+------------------------------------------------------------------+
//| Ù…Ø¹Ø§Ù„Ø¬ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ¯Ø§ÙˆÙ„                                             |
//+------------------------------------------------------------------+
void OnTrade() {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ ØµÙÙ‚Ø©
    static int last_deals_total = 0;
    int current_deals_total = HistoryDealsTotal();
    
    if(current_deals_total > last_deals_total) {
        // ØµÙÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…ØºÙ„Ù‚Ø©
        if(HistorySelect(0, TimeCurrent())) {
            for(int i = last_deals_total; i < current_deals_total; i++) {
                ulong ticket = HistoryDealGetTicket(i);
                if(ticket > 0) {
                    if(HistoryDealGetInteger(ticket, DEAL_MAGIC) == InpMagicNumber &&
                       HistoryDealGetInteger(ticket, DEAL_ENTRY) == DEAL_ENTRY_OUT) {
                        
                        double profit = HistoryDealGetDouble(ticket, DEAL_PROFIT);
                        
                        if(profit > 0) {
                            stats.winning_trades++;
                            stats.total_profit += profit;
                            stats.consecutive_wins++;
                            stats.consecutive_losses = 0;
                            
                            if(profit > stats.max_profit) {
                                stats.max_profit = profit;
                            }
                        }
                        else if(profit < 0) {
                            stats.losing_trades++;
                            stats.total_loss += profit;
                            stats.consecutive_losses++;
                            stats.consecutive_wins = 0;
                            
                            if(profit < stats.max_loss) {
                                stats.max_loss = profit;
                            }
                        }
                    }
                }
            }
        }
        
        last_deals_total = current_deals_total;
    }
}

//+------------------------------------------------------------------+
//| Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ                                       |
//+------------------------------------------------------------------+
void PrintPerformanceSummary() {
    double final_balance = account_info.Balance();
    double profit_loss = final_balance - initial_balance;
    double profit_percent = (initial_balance > 0) ? 
                           (profit_loss / initial_balance) * 100 : 0;
    
    Print("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    Print("â•‘              Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ                  â•‘");
    Print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    Print("â•‘ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ: ", DoubleToString(initial_balance, 2));
    Print("â•‘ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ", DoubleToString(final_balance, 2));
    Print("â•‘ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©: ", DoubleToString(profit_loss, 2), 
          " (", DoubleToString(profit_percent, 2), "%)");
    Print("â•‘ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙ‚Ø§Øª: ", stats.total_trades);
    
    if(stats.total_trades > 0) {
        double win_rate = (double)stats.winning_trades / stats.total_trades * 100;
        Print("â•‘ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙÙˆØ²: ", DoubleToString(win_rate, 1), "%");
        Print("â•‘ Ø£ÙƒØ¨Ø± Ø±Ø¨Ø­: ", DoubleToString(stats.max_profit, 2));
        Print("â•‘ Ø£ÙƒØ¨Ø± Ø®Ø³Ø§Ø±Ø©: ", DoubleToString(stats.max_loss, 2));
        
        double avg_profit = (stats.winning_trades > 0) ? 
                           stats.total_profit / stats.winning_trades : 0;
        double avg_loss = (stats.losing_trades > 0) ? 
                         stats.total_loss / stats.losing_trades : 0;
        
        Print("â•‘ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø¨Ø­: ", DoubleToString(avg_profit, 2));
        Print("â•‘ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø®Ø³Ø§Ø±Ø©: ", DoubleToString(avg_loss, 2));
    }
    
    double max_drawdown = ((peak_balance - final_balance) / peak_balance) * 100;
    Print("â•‘ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø£Ù‚ØµÙ‰: ", DoubleToString(max_drawdown, 2), "%");
    Print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
}

//+------------------------------------------------------------------+
//| Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø³Ø¨Ø¨ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù                                      |
//+------------------------------------------------------------------+
string GetDeInitReasonText(int reason) {
    switch(reason) {
        case REASON_PROGRAM:     return "Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙˆÙ‚Ù";
        case REASON_REMOVE:      return "Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø´Ø§Ø±Øª";
        case REASON_RECOMPILE:   return "Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ø¬Ù…Ø©";
        case REASON_CHARTCHANGE: return "ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø§Ø±Øª";
        case REASON_CHARTCLOSE:  return "Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Ø±Øª";
        case REASON_PARAMETERS:  return "ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª";
        case REASON_ACCOUNT:     return "ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨";
        default:                 return "Ø³Ø¨Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    }
}

//+------------------------------------------------------------------+
